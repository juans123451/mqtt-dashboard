<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üå± Dashboard IoT ‚Äî SISTEMA AUTOMATIZADO DE RIEGO</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <style>
      :root {
        --teal-primary: #0d9488;
        --teal-dark: #115e59;
        --teal-light: #14b8a6;
        --orange-accent: #fb923c;
        --orange-dark: #ea580c;
        --blue-accent: #06b6d4;
        --cyan-light: #22d3ee;
        --bg-gradient-start: #134e4a;
        --bg-gradient-end: #064e3b;
        --card-overlay: rgba(255, 255, 255, 0.08);
        --text-primary: #ffffff;
        --text-secondary: #d1fae5;
        --shadow-strong: rgba(0, 0, 0, 0.5);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
        color: var(--text-primary);
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
        padding: 2rem 1rem;
      }
      .voice-btn {
  width: 100%;
  padding: 1rem;
  margin-bottom: 0.9rem;
  background: linear-gradient(135deg, var(--orange-accent), var(--orange-dark));
  color: white;
  border: none;
  border-radius: 18px;
  cursor: pointer;
  font-weight: 800;
  font-size: 1.05rem;
  letter-spacing: 0.6px;
  text-transform: uppercase;
  box-shadow: 0 8px 25px rgba(251, 146, 60, 0.6);
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.voice-btn:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 12px 35px rgba(251, 146, 60, 0.8);
}

.voice-btn:active {
  transform: scale(0.97);
}

.voice-btn.listening {
  background: linear-gradient(135deg, #ef4444, #b91c1c);
  box-shadow: 0 0 25px rgba(239, 68, 68, 0.9);
  animation: pulse-voice 1.5s infinite;
}

@keyframes pulse-voice {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 0 25px rgba(239, 68, 68, 0.9);
  }
  50% {
    transform: scale(1.08);
    box-shadow: 0 0 40px rgba(239, 68, 68, 1);
  }
}


      body::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image:
          radial-gradient(circle at 20% 30%, rgba(20, 184, 166, 0.12) 0%, transparent 50%),
          radial-gradient(circle at 80% 70%, rgba(251, 146, 60, 0.08) 0%, transparent 50%);
        pointer-events: none;
        z-index: 0;
      }

      .header {
        text-align: center;
        margin-bottom: 3rem;
        z-index: 1;
        max-width: 900px;
        width: 100%;
        position: relative;
      }

      h1 {
        font-size: 3.2rem;
        font-weight: 900;
        background: linear-gradient(135deg, #14b8a6, #22d3ee, #fb923c);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        margin-bottom: 0.8rem;
        letter-spacing: -1px;
        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .subtitle {
        color: var(--text-secondary);
        font-size: 1.2rem;
        opacity: 0.9;
        font-weight: 500;
        letter-spacing: 0.5px;
      }

      /* === CONTENEDOR PRINCIPAL === */
      .main-container {
        display: flex;
        gap: 2rem;
        max-width: 1900px;
        width: 100%;
        margin: 0 auto;
        position: relative;
        z-index: 1;
      }

      /* === DASHBOARD === */
      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
        flex: 1;
        min-width: 0;
        max-width: calc(100% - 400px);
      }

      .card {
        background: var(--card-overlay);
        backdrop-filter: blur(20px);
        padding: 2rem 1.8rem;
        border-radius: 28px;
        box-shadow:
          0 20px 50px var(--shadow-strong),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        text-align: center;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        border: 1px solid rgba(255, 255, 255, 0.12);
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, var(--orange-accent), var(--teal-light), var(--cyan-light));
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .card:hover::before {
        transform: scaleX(1);
      }

      .card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow:
          0 30px 60px rgba(20, 184, 166, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.2);
        border-color: rgba(20, 184, 166, 0.4);
      }

      .sensor-icon {
        font-size: 3.5rem;
        margin-bottom: 1.3rem;
        display: block;
        filter: drop-shadow(0 0 15px rgba(20, 184, 166, 0.5));
        transition: all 0.4s ease;
      }

      .card:hover .sensor-icon {
        transform: scale(1.15) rotate(5deg);
        filter: drop-shadow(0 0 25px rgba(251, 146, 60, 0.7));
      }

      .sensor-label {
        font-size: 0.95rem;
        color: var(--orange-accent);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        margin-bottom: 1.1rem;
        font-weight: 700;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .sensor-value {
        font-size: 3rem;
        font-weight: 900;
        background: linear-gradient(135deg, #14b8a6, #22d3ee);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        margin-bottom: 0.4rem;
        line-height: 1;
        text-shadow: 0 0 20px rgba(20, 184, 166, 0.4);
      }

      .sensor-unit {
        font-size: 1.1rem;
        color: var(--cyan-light);
        opacity: 0.9;
        font-weight: 600;
      }

      .status-bar {
        margin-top: 1.3rem;
        padding-top: 1.1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.15);
        font-size: 0.9rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.7rem;
        font-weight: 600;
      }

      .status-indicator {
        width: 10px;
        height: 10px;
        background: var(--teal-light);
        border-radius: 50%;
        animation: pulse-teal 2s infinite;
        box-shadow: 0 0 12px var(--teal-light);
      }

      @keyframes pulse-teal {
        0%, 100% {
          opacity: 1;
          box-shadow: 0 0 12px var(--teal-light);
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          box-shadow: 0 0 20px var(--cyan-light);
          transform: scale(1.1);
        }
      }

      .led-buttons, .servo-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.3rem;
        flex-wrap: wrap;
      }

      .led-btn, .servo-btn {
        background: rgba(20, 184, 166, 0.2);
        color: var(--text-primary);
        border: 2px solid rgba(20, 184, 166, 0.3);
        border-radius: 16px;
        padding: 0.8rem 1.6rem;
        cursor: pointer;
        font-weight: 700;
        font-size: 1rem;
        letter-spacing: 0.5px;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        min-width: 110px;
        text-transform: uppercase;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .led-btn:hover, .servo-btn:hover {
        background: linear-gradient(135deg, var(--teal-light), var(--cyan-light));
        color: #064e3b;
        border-color: var(--cyan-light);
        box-shadow: 0 8px 25px rgba(20, 184, 166, 0.6);
        transform: translateY(-3px);
      }

      .led-btn.active, .servo-btn.active {
        background: linear-gradient(135deg, var(--orange-accent), var(--orange-dark));
        color: white;
        border-color: var(--orange-accent);
        box-shadow: 0 8px 30px rgba(251, 146, 60, 0.7);
        transform: scale(1.05);
      }

      /* === CHAT LATERAL === */
      .chat-sidebar {
        width: 380px;
        background: rgba(6, 78, 59, 0.7);
        backdrop-filter: blur(24px);
        border-radius: 28px;
        display: flex;
        flex-direction: column;
        box-shadow:
          0 20px 60px rgba(0, 0, 0, 0.6),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.15);
        height: calc(100vh - 4rem);
        position: sticky;
        top: 2rem;
        overflow: hidden;
      }

      .chat-header {
        padding: 1.6rem 1.5rem 1.2rem;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        background: linear-gradient(135deg, rgba(20, 184, 166, 0.2), rgba(6, 182, 212, 0.1));
      }

      .chat-header h2 {
        font-size: 1.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #14b8a6, #22d3ee);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.7rem;
      }

      #chat-messages {
        flex: 1;
        padding: 1.2rem;
        overflow-y: auto;
        background: rgba(4, 47, 46, 0.6);
        font-size: 0.95rem;
        color: var(--text-primary);
        scrollbar-width: thin;
        scrollbar-color: var(--teal-light) rgba(0, 0, 0, 0.3);
      }

      #chat-messages::-webkit-scrollbar {
        width: 8px;
      }

      #chat-messages::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, var(--teal-light), var(--cyan-light));
        border-radius: 10px;
      }

      #chat-messages::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
      }

      .put-group {
        padding: 1.2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(6, 78, 59, 0.8);
      }

      #chat-input {
        width: 100%;
        padding: 1rem 1.3rem;
        border: 2px solid rgba(20, 184, 166, 0.3);
        border-radius: 18px;
        background: rgba(4, 47, 46, 0.6);
        color: var(--text-primary);
        font-family: "Inter", sans-serif;
        font-size: 0.95rem;
        outline: none;
        margin-bottom: 0.9rem;
        transition: all 0.3s ease;
      }

      #chat-input:focus {
        border-color: var(--teal-light);
        box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.2);
        background: rgba(4, 47, 46, 0.8);
      }

      #chat-input::placeholder {
        color: var(--cyan-light);
        opacity: 0.6;
      }

      #chat-send {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, var(--teal-light), var(--cyan-light));
        color: #064e3b;
        border: none;
        border-radius: 18px;
        cursor: pointer;
        font-weight: 800;
        font-size: 1.05rem;
        letter-spacing: 0.5px;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: 0 6px 20px rgba(20, 184, 166, 0.4);
        text-transform: uppercase;
      }

      #chat-send:hover {
        background: linear-gradient(135deg, var(--cyan-light), var(--teal-light));
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(34, 211, 238, 0.6);
      }

      #chat-send:active {
        transform: translateY(0);
      }

      .chat-message {
        padding: 1rem 1.2rem;
        border-radius: 18px;
        margin-bottom: 1rem;
        max-width: 85%;
        word-break: break-word;
        line-height: 1.5;
        font-size: 0.95rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .user-message {
        background: linear-gradient(135deg, #14b8a6, #0d9488);
        color: white;
        margin-left: auto;
        text-align: right;
        font-weight: 600;
      }

      .bot-message {
        background: rgba(20, 184, 166, 0.15);
        color: var(--text-secondary);
        margin-right: auto;
        text-align: left;
        border: 1px solid rgba(20, 184, 166, 0.25);
      }

      .loading-message {
        display: flex;
        align-items: center;
        gap: 0.7rem;
        opacity: 0.9;
      }

      /* === M√ìVIL === */
      .mobile-chat-toggle {
        display: none;
        position: fixed;
        bottom: 2rem;
        right: 1.5rem;
        width: 70px;
        height: 70px;
        background: linear-gradient(135deg, var(--orange-accent), var(--orange-dark));
        color: white;
        border-radius: 50%;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(251, 146, 60, 0.6);
        z-index: 100;
        transition: all 0.3s ease;
      }

      .mobile-chat-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 12px 40px rgba(251, 146, 60, 0.8);
      }

      .mobile-chat {
        display: none;
        position: fixed;
        bottom: 2rem;
        right: 1.5rem;
        width: calc(100% - 2rem);
        max-width: 400px;
        height: 55vh;
        background: rgba(6, 78, 59, 0.95);
        backdrop-filter: blur(24px);
        border-radius: 28px;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
        z-index: 100;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.15);
      }

      .mobile-chat-header {
        padding: 1.2rem;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, rgba(20, 184, 166, 0.2), rgba(6, 182, 212, 0.1));
      }

      .mobile-chat-header h3 {
        font-size: 1.2rem;
        background: linear-gradient(135deg, #14b8a6, #22d3ee);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        font-weight: 800;
      }

      .close-mobile-chat {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .close-mobile-chat:hover {
        color: var(--orange-accent);
        transform: rotate(90deg);
      }

      .mobile-chat-messages {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        background: rgba(4, 47, 46, 0.6);
        font-size: 0.95rem;
        color: var(--text-primary);
      }

      .mobile-chat-input-group {
        padding: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(6, 78, 59, 0.8);
      }

      .mobile-chat-input-group input {
        width: 100%;
        padding: 0.9rem 1.2rem;
        margin-bottom: 0.7rem;
        border-radius: 16px;
        border: 2px solid rgba(20, 184, 166, 0.3);
        background: rgba(4, 47, 46, 0.6);
        color: var(--text-primary);
        font-family: "Inter", sans-serif;
        outline: none;
      }

      .mobile-chat-input-group input:focus {
        border-color: var(--teal-light);
      }

      .mobile-chat-input-group button {
        width: 100%;
        padding: 0.9rem;
        background: linear-gradient(135deg, var(--teal-light), var(--cyan-light));
        color: #064e3b;
        border: none;
        font-weight: 800;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
      }

      .mobile-chat-input-group button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(20, 184, 166, 0.5);
      }

      /* === MEDIA QUERIES === */
      @media (max-width: 1100px) {
        .main-container {
          flex-direction: column;
          align-items: center;
        }

        .dashboard {
          max-width: 100%;
        }

        .chat-sidebar {
          display: none;
        }

        .mobile-chat-toggle {
          display: block;
        }
      }

      @media (max-width: 768px) {
        h1 {
          font-size: 2.5rem;
        }

        .subtitle {
          font-size: 1.1rem;
        }

        .dashboard {
          grid-template-columns: 1fr;
          gap: 1.5rem;
        }

        .sensor-value {
          font-size: 2.5rem;
        }
      }
    </style>
  </head>

  <body>
    <div class="header">
      <h1>üåæ Dashboard IoT ‚Äî SISTEMA DE MONITOREO DE UN HUERTO</h1>
      <p class="subtitle">Monitoreo y control en tiempo real con ESP32</p>
    </div>

    <div class="main-container">
      <!-- CHAT FIJO A LA IZQUIERDA (en desktop) -->
      <div class="chat-sidebar">
        <div class="chat-header">
          <h2>ü§ñ Asistente Agr√≠cola</h2>
        </div>
        <div id="chat-messages"></div>
        <div class="chat-input-group">
          <button id="voiceBtnDesktop" class="voice-btn">üéôÔ∏è Hablar</button>

          <input
            id="chat-input"
            type="text"
            placeholder="Ej: ¬øDebo regar? ¬øEst√° bien la temp?"
          />
          <button id="chat-send">Enviar</button>
        </div>
      </div>

      <!-- DASHBOARD PRINCIPAL -->
      <div class="dashboard">
        <div class="card">
          <span class="sensor-icon">üå°Ô∏è</span>
          <div class="sensor-label">Temperatura Ambiente</div>
          <div class="sensor-value"><span id="tempDHT">--</span><span class="sensor-unit">¬∞C</span></div>
          <div class="status-bar"><span class="status-indicator"></span> Sensor DHT11</div>
        </div>

        <div class="card">
          <span class="sensor-icon">üíß</span>
          <div class="sensor-label">Humedad suelo</div>
          <div class="sensor-value"><span id="humDHT">--</span><span class="sensor-unit">%</span></div>
          <div class="status-bar"><span class="status-indicator"></span> Sensor DHT11</div>
        </div>

        <div class="card">
          <span class="sensor-icon">üå§Ô∏è</span>
          <div class="sensor-label">Temperatura BMP</div>
          <div class="sensor-value"><span id="tempBMP">--</span><span class="sensor-unit">¬∞C</span></div>
          <div class="status-bar"><span class="status-indicator"></span> Sensor BMP180</div>
        </div>

        <div class="card">
          <span class="sensor-icon">üß≠</span>
          <div class="sensor-label">Presi√≥n Atmosf√©rica</div>
          <div class="sensor-value"><span id="presion">--</span><span class="sensor-unit">hPa</span></div>
          <div class="status-bar"><span class="status-indicator"></span> Sensor BMP180</div>
        </div>

        <div class="card">
          <span class="sensor-icon">üõ¢Ô∏è</span>
          <div class="sensor-label">nivel de tanque</div>
          <div class="sensor-value"><span id="nivel">--</span><span class="sensor-unit"></span></div>
          <div class="status-bar"><span class="status-indicator"></span> Sensor Ultras√≥nico</div>
        </div>

        <div class="card">
          <span class="sensor-icon">üí°</span>
          <div class="sensor-label">Control de LED</div>
          <div class="led-buttons">
            <button id="btnOn" class="led-btn">Encender</button>
            <button id="btnOff" class="led-btn">Apagar</button>
          </div>
          <div class="status-bar"><span class="status-indicator"></span> Control v√≠a MQTT</div>
        </div>

        <div class="card">
          <span class="sensor-icon">‚öôÔ∏è</span>
          <div class="sensor-label">Control de Servomotor</div>
          <div class="servo-buttons">
            <button id="btnAbrir" class="servo-btn">Abrir</button>
            <button id="btnCerrar" class="servo-btn">Cerrar</button>
          </div>
          <div class="status-bar"><span class="status-indicator"></span> Servo controlado v√≠a MQTT</div>
        </div>
      </div>
    </div>

    <!-- BOT√ìN FLOTANTE EN M√ìVIL -->
    <button class="mobile-chat-toggle" id="mobileChatBtn">üí¨</button>

    <!-- CHAT M√ìVIL (oculto por defecto) -->
    <div class="mobile-chat" id="mobileChat">
      <div class="mobile-chat-header">
        <h3>ü§ñ Asistente Agr√≠cola</h3>
        <button class="close-mobile-chat" id="closeMobileChat">‚úï</button>
      </div>
      <div class="mobile-chat-messages" id="mobileChatMessages"></div>
      <div class="mobile-chat-input-group">
        <button id="voiceBtnMobile" class="voice-btn">üéôÔ∏è Hablar</button>

        <input type="text" id="mobileChatInput" placeholder="Escribe tu pregunta..." />
        <button id="mobileChatSend">Enviar</button>
      </div>
    </div>

    <script>
      const socket = io();

      let currentSensorData = {
        temperatura_dht: "--",
        humedad_suelo: "--",
        temperatura_bmp: "--",
        presion: "--",
        nivel_tanque: "--"
      };

      socket.on("sensorData", (data) => {
        currentSensorData = data;
        document.getElementById("tempDHT").textContent = data.temperatura_dht?.toFixed(1) ?? "--";
        document.getElementById("humDHT").textContent = data.humedad_suelo?.toFixed(1) ?? "--";
        document.getElementById("tempBMP").textContent = data.temperatura_bmp?.toFixed(1) ?? "--";
        document.getElementById("presion").textContent = data.presion?.toFixed(1) ?? "--";
       document.getElementById("nivel").textContent = data.nivel_tanque ?? "--";

      });

      // === CONTROLES LED/SERVO ===
      const btnOn = document.getElementById("btnOn");
      const btnOff = document.getElementById("btnOff");
      btnOn.addEventListener("click", () => {
        socket.emit("ledControl", "ON");
        btnOn.classList.add("active");
        btnOff.classList.remove("active");
      });
      btnOff.addEventListener("click", () => {
        socket.emit("ledControl", "OFF");
        btnOff.classList.add("active");
        btnOn.classList.remove("active");
      });

      const btnAbrir = document.getElementById("btnAbrir");
      const btnCerrar = document.getElementById("btnCerrar");
      btnAbrir.addEventListener("click", () => {
        socket.emit("servoControl", "ABRIR");
        btnAbrir.classList.add("active");
        btnCerrar.classList.remove("active");
      });
      btnCerrar.addEventListener("click", () => {
        socket.emit("servoControl", "CERRAR");
        btnCerrar.classList.add("active");
        btnAbrir.classList.remove("active");
      });

      // === FUNCIONES PARA EL CHAT ===
      function appendMessage(text, sender, containerId, isLoading = false) {
        const container = document.getElementById(containerId);
        const messageDiv = document.createElement("div");
        const id = "msg-" + Date.now();
        messageDiv.id = id;
        messageDiv.classList.add("chat-message");
        messageDiv.classList.add(sender === "user" ? "user-message" : "bot-message");

        if (isLoading) {
          messageDiv.innerHTML = `<span>Analizando... ü§ñ</span> <span style="opacity:0.8">‚è≥</span>`;
        } else {
          messageDiv.textContent = text;
        }

        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
        return id;
      }
      socket.on("botMessage", (msg) => {
  appendMessage(msg, "bot", "chat-messages");
});

      function removeMessage(id, containerId) {
        const container = document.getElementById(containerId);
        const el = container.querySelector(`#${id}`);
        if (el) el.remove();
      }

      async function sendMessage(userMessage, containerId, inputId) {
        if (!userMessage.trim()) return;

        const input = document.getElementById(inputId);
        input.value = "";
        const loadingId = appendMessage("Analizando... ü§ñ", "bot", containerId, true);

        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: userMessage,
              sensorData: currentSensorData
            })
          });

          const result = await response.json();
          removeMessage(loadingId, containerId);
          appendMessage(result.response || "No pude generar una recomendaci√≥n.", "bot", containerId);
        } catch (error) {
          removeMessage(loadingId, containerId);
          appendMessage("‚ö†Ô∏è Error al conectar con el asistente.", "bot", containerId);
        }
      }


      // === EVENTOS DESKTOP ===
      const chatInput = document.getElementById("chat-input");
      const chatSend = document.getElementById("chat-send");
      chatSend.addEventListener("click", () => {
        sendMessage(chatInput.value, "chat-messages", "chat-input");
      });
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") chatSend.click();
      });

      // === EVENTOS M√ìVIL ===
      const mobileChatBtn = document.getElementById("mobileChatBtn");
      const mobileChat = document.getElementById("mobileChat");
      const closeMobileChat = document.getElementById("closeMobileChat");
      const mobileChatInput = document.getElementById("mobileChatInput");
      const mobileChatSend = document.getElementById("mobileChatSend");

      mobileChatBtn.addEventListener("click", () => {
        mobileChat.style.display = "flex";
      });

      closeMobileChat.addEventListener("click", () => {
        mobileChat.style.display = "none";
      });

      mobileChatSend.addEventListener("click", () => {
        sendMessage(mobileChatInput.value, "mobileChatMessages", "mobileChatInput");
      });

      mobileChatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") mobileChatSend.click();
      });
      // ================= VOZ =================
const voiceBtn = document.getElementById("voiceBtn");

const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

function initVoice(buttonId, chatContainer) {
  const btn = document.getElementById(buttonId);
  if (!btn || !SpeechRecognition) return;

  const recognition = new SpeechRecognition();
  recognition.lang = "es-ES";
  recognition.continuous = false;
  recognition.interimResults = false;

  btn.addEventListener("click", () => {
    recognition.start();
    appendMessage("üéôÔ∏è Escuchando...", "bot", chatContainer);
  });

  recognition.onresult = (event) => {
    const texto = event.results[0][0].transcript.toLowerCase();
    appendMessage(texto, "user", chatContainer);
    socket.emit("voiceCommand", texto);
  };

  recognition.onerror = () => {
    appendMessage("‚ùå Error al reconocer la voz", "bot", chatContainer);
  };
}

initVoice("voiceBtnDesktop", "chat-messages");
initVoice("voiceBtnMobile", "mobileChatMessages");

    </script>
  </body>
</html>